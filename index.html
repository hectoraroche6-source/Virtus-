<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VIRTUD PRO V1.1</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #00f2ff;
    --bg: #050a10;
    --panel-bg: #0f1219;
    --text: #ffffff;
    --accent: #ff0055;
    --success: #00ff88;
    --dynamic-color: #00f2ff; /* Color cambiable para botones globales */
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: 'Rajdhani', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; padding-bottom: 80px; }
h1, h2, h3 { font-family: 'Orbitron', sans-serif; margin: 0; }

/* --- UTILIDADES --- */
.hidden { display: none !important; }
.btn { border: none; padding: 10px 15px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-weight: bold; text-transform: uppercase; transition: 0.2s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
.btn-main { background: var(--primary); color: #000; width: 100%; margin-bottom: 10px; }
.btn-main:active { transform: scale(0.95); }
.btn-danger { background: var(--accent); color: white; width: 100%; }
.btn-dynamic { background: var(--dynamic-color); color: black; box-shadow: 0 0 10px var(--dynamic-color); }

input, select, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 12px; color: white; margin-bottom: 10px; font-family: 'Rajdhani', sans-serif; font-size: 1rem; }
input[type="file"] { padding: 5px; }

/* --- PORTADA --- */
#landing { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-size: cover; background-position: center; z-index: 2000; }
.landing-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 1; }
.landing-content { position: relative; z-index: 2; text-align: center; padding: 20px; width: 95%; }
#landingTitle { font-size: clamp(2rem, 10vw, 4rem); line-height: 1.1; text-shadow: 0 0 20px var(--primary); margin-bottom: 30px; }

/* COLORES PORTADA (NUEVOS) */
.btn-neon-blue { background: linear-gradient(45deg, #00f2ff, #0044ff); color: white; box-shadow: 0 0 15px #00f2ff; }
.btn-neon-red { background: linear-gradient(45deg, #ff0055, #ff0000); color: white; box-shadow: 0 0 15px #ff0055; }
.btn-neon-green { background: linear-gradient(45deg, #00ff88, #00cc44); color: black; box-shadow: 0 0 15px #00ff88; }
.btn-neon-purple { background: linear-gradient(45deg, #aa00ff, #ff00cc); color: white; box-shadow: 0 0 15px #aa00ff; }
.btn-neon-gold { background: linear-gradient(45deg, #ffd700, #ffaa00); color: black; box-shadow: 0 0 15px #ffd700; }
.btn-neon-pink { background: linear-gradient(45deg, #ff00cc, #ff66cc); color: white; box-shadow: 0 0 15px #ff00cc; }
.btn-neon-cyan { background: linear-gradient(45deg, #00ffff, #00aaaa); color: black; box-shadow: 0 0 15px #00ffff; }
.btn-neon-orange { background: linear-gradient(45deg, #ff8800, #ff4400); color: white; box-shadow: 0 0 15px #ff8800; }

/* ANIMACIONES PORTADA (AMPLIADO) */
.anim-pulse { animation: pulse 2s infinite; }
.anim-bounce { animation: bounce 2s infinite; }
.anim-shake { animation: shake 3s infinite; }
.anim-spin { animation: spin 3s infinite linear; }
.anim-wobble { animation: wobble 2s infinite; }
.anim-jello { animation: jello 2s infinite; }
.anim-heartbeat { animation: heartbeat 1.5s infinite; }
.anim-flip { animation: flip 3s infinite; }
.anim-zoomIn { animation: zoomIn 2s infinite; }
.anim-slideUp { animation: slideUp 2s infinite; }

@keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }
@keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
@keyframes shake { 0% {transform: translateX(0);} 10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);} 20%, 40%, 60%, 80% {transform: translateX(5px);} 100% {transform: translateX(0);} }
@keyframes spin { 100% { transform: rotate(360deg); } }
@keyframes wobble { 0%,100%{transform:translateX(0) rotate(0);} 15%{transform:translateX(-25%) rotate(-5deg);} 30%{transform:translateX(20%) rotate(3deg);} 45%{transform:translateX(-15%) rotate(-3deg);} 60%{transform:translateX(10%) rotate(2deg);} 75%{transform:translateX(-5%) rotate(-1deg);} }
@keyframes jello { 0%,100%{transform:scale3d(1,1,1);} 30%{transform:scale3d(1.25,0.75,1);} 40%{transform:scale3d(0.75,1.25,1);} 50%{transform:scale3d(1.15,0.85,1);} 65%{transform:scale3d(0.95,1.05,1);} 75%{transform:scale3d(1.05,0.95,1);} }
@keyframes heartbeat { 0%{transform:scale(1);} 14%{transform:scale(1.3);} 28%{transform:scale(1);} 42%{transform:scale(1.3);} 70%{transform:scale(1);} }
@keyframes flip { 0% {transform: perspective(400px) rotateY(0);} 100% {transform: perspective(400px) rotateY(360deg);} }
@keyframes zoomIn { 0% {opacity:0; transform: scale(0.3);} 50% {opacity:1; transform: scale(1);} 100% {opacity:0; transform: scale(0.3);} }
@keyframes slideUp { 0% {transform: translateY(20px); opacity:0;} 50% {transform: translateY(0); opacity:1;} 100% {transform: translateY(-20px); opacity:0;} }

/* --- APP HEADER --- */
header { background: rgba(0,0,0,0.9); padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; }
.header-center { text-align: center; flex-grow: 1; }
.auth-icon { font-size: 1.5rem; cursor: pointer; position: relative; }
.auth-status { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-radius: 50%; background: gray; border: 1px solid black; }
.auth-status.online { background: var(--success); }

.subtitle { font-size: 0.9rem; color: #aaa; margin-top: 5px; display: block;}

/* Animaciones Subtitulo */
.sub-fade { animation: fadeIO 3s infinite; }
.sub-slide { animation: slideIn 3s infinite; }
.sub-glitch { text-shadow: 2px 0 red, -2px 0 blue; }
.sub-neon { text-shadow: 0 0 10px var(--primary); }
.sub-type { border-right: 2px solid var(--primary); overflow: hidden; white-space: nowrap; animation: typing 4s steps(40) infinite; margin: 0 auto; display: inline-block;}
@keyframes fadeIO { 0%,100%{opacity:0.3} 50%{opacity:1} }
@keyframes typing { from{width:0} to{width:100%} }

/* --- NAV & GRID --- */
.sections-nav { display: flex; overflow-x: auto; gap: 10px; padding: 15px; background: #0a0f1f; position: sticky; top: 70px; z-index: 90; scrollbar-width: none; }
.section-tab { background: #1c2541; padding: 10px 20px; border-radius: 20px; white-space: nowrap; color: #888; border: 1px solid #333; transition: 0.3s; font-family: 'Orbitron', sans-serif; cursor: pointer; }
.section-tab.active { background: var(--dynamic-color); color: black; font-weight: bold; border: 2px solid white; box-shadow: 0 0 15px var(--dynamic-color); transform: scale(1.05); }

.grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; padding-top: 20px; }
.card { background: #151a25; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #333; transition: 0.3s; }
.card img { width: 100%; height: 120px; object-fit: cover; cursor: pointer; } /* Click en img abre detalle */
.card-content { padding: 10px; }
.card h4 { font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.card .price { color: var(--success); font-weight: bold; font-size: 1.1rem; }

/* --- MODALES GENERALES (Full Screen) --- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 4000; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; animation: fadeIn 0.3s; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
.modal-close { background: none; border: none; color: white; font-size: 1.5rem; }

/* Modal Producto Detalle */
#prodDetailImg { width: 100%; height: 300px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--primary); }
.detail-price { font-size: 2rem; color: var(--success); font-family: 'Orbitron'; margin: 10px 0; }
.detail-desc { font-size: 1rem; color: #ccc; line-height: 1.5; margin-bottom: 20px; background: #111; padding: 15px; border-radius: 5px; }

/* Chat UI */
.chat-container { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
.chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #050a10; border: 1px solid #333; margin-bottom: 10px; border-radius: 5px; }
.chat-input-area { display: flex; gap: 10px; }
.msg-bubble { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; font-size: 0.9rem; }
.msg-me { background: var(--primary); color: black; align-self: flex-end; margin-left: auto; }
.msg-other { background: #333; color: white; align-self: flex-start; }
.admin-pic { width: 30px; height: 30px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }

/* --- ADMIN PANEL --- */
#adminPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; overflow-y: auto; display: flex; flex-direction: column; }
.admin-header { background: #111; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 10; }
.dash-btn { background: #1c2541; padding: 20px; text-align: center; border-radius: 10px; border: 1px solid #333; cursor: pointer; transition: 0.3s; }
.dash-btn:hover { border-color: var(--primary); background: #222; }
.list-item { background: #222; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; }

/* Botones flotantes */
.fab-admin { position: fixed; right: 20px; top: 80px; background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #555; z-index: 500; cursor: pointer; }
.fab-cart { position: fixed; right: 20px; bottom: 20px; background: var(--dynamic-color); color: black; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 0 20px var(--dynamic-color); z-index: 400; font-weight: bold; transition: 0.2s;}

/* Animacion Flecha */
.flying-arrow { position: fixed; z-index: 9999; font-size: 2.2rem; color: var(--primary); pointer-events: none; text-shadow: 0 0 15px var(--primary); transition: all 1s cubic-bezier(0.19, 1, 0.22, 1); }

@keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }

</style>
</head>
<body>

<div id="landing">
    <div class="landing-overlay"></div>
    <div class="landing-content">
        <h1 id="landingTitle">VIRTUD</h1>
        <button id="landingBtn" class="btn btn-neon-blue anim-pulse" style="padding: 15px 50px; font-size: 1.2rem;" onclick="enterSite()">ENTRAR</button>
    </div>
</div>

<div class="fab-admin" onclick="openAdmin()" id="adminTrigger" style="display:none;">‚öôÔ∏è</div>

<div id="app" class="hidden">
    <header>
        <div id="userAuthIcon" class="auth-icon hidden" onclick="openAuthModal()">
            üë§ <div id="authStatusDot" class="auth-status"></div>
        </div>
        
        <div class="header-center">
            <h2 id="appTitle">VIRTUD STORE</h2>
            <div id="appSubtitle" class="subtitle sub-fade">Bienvenido</div>
        </div>
    </header>

    <div style="padding: 15px;">
        <input type="text" id="mainSearch" placeholder="Buscar..." onkeyup="searchEngine(this.value)">
    </div>

    <div id="sectionsNav" class="sections-nav"></div>
    <div id="contentArea"></div>
</div>

<div class="fab-cart" id="cartBtn" style="display:none;" onclick="toggleCart()">0</div>

<div id="cartModal" class="hidden modal-overlay">
    <div class="modal-header">
        <h3 style="color:var(--primary)">TU PEDIDO</h3>
        <button onclick="toggleCart()" class="modal-close">‚úï</button>
    </div>
    <div id="cartItemsList" style="flex:1; overflow-y:auto; padding-right:5px;"></div>
    <div style="margin-top:auto; padding-top:20px; border-top:1px solid #333;">
        <h3 style="display:flex; justify-content:space-between;">
            <span>TOTAL:</span> <span id="cartTotalDisplay" style="color:var(--success)">$0.00</span>
        </h3>
        <button id="btnMakeOrder" class="btn btn-main" onclick="sendOrder()" style="margin-top:10px; height:60px; font-size:1.2rem;">HACER PEDIDO</button>
    </div>
</div>

<div id="productDetailModal" class="hidden modal-overlay">
    <div class="modal-header">
        <h3 id="detailTitle" style="color:var(--primary)">Nombre Producto</h3>
        <button onclick="closeDetail()" class="modal-close">‚úï</button>
    </div>
    <img id="prodDetailImg" src="">
    <div class="detail-price" id="detailPrice">$0.00</div>
    <div class="detail-desc" id="detailDesc">Descripci√≥n...</div>
    <button id="detailAddBtn" class="btn btn-main" style="font-size:1.3rem; padding:20px;">¬°AGREGAR AL CARRITO!</button>
</div>

<div id="authModal" class="hidden modal-overlay">
    <div class="modal-header">
        <h3 id="authTitle" style="color:var(--primary)">ACCESO USUARIO</h3>
        <button onclick="closeAuth()" class="modal-close">‚úï</button>
    </div>
    
    <div id="authForms">
        <div style="text-align:center; margin-bottom:20px;">Reg√≠strate para contactar a Soporte.</div>
        <input id="userNameInput" placeholder="Tu Nombre">
        <input id="userEmailInput" placeholder="Correo / ID √önico">
        <button class="btn btn-main" onclick="registerUser()">REGISTRAR / ENTRAR</button>
    </div>

    <div id="userChatView" class="hidden chat-container">
        <div class="chat-messages" id="userChatMsgs"></div>
        <div class="chat-input-area">
            <input id="userChatInput" placeholder="Escribe a Administraci√≥n...">
            <button class="btn btn-main" style="width:auto;" onclick="userSendMsg()">‚û§</button>
        </div>
    </div>
</div>

<div id="adminPanel" class="hidden">
    <div class="admin-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="adminBack()" id="adminBackBtn" class="hidden">‚¨Ö</button>
            <h3 style="color:var(--primary)">PANEL DE CONTROL</h3>
        </div>
        <div>
            <button onclick="minimizeAdmin()">_</button>
            <button onclick="closeAdmin(true)" style="background:var(--accent)">‚úñ</button>
        </div>
    </div>

    <div class="admin-body">
        
        <div id="adminDashboard" class="admin-section">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="dash-btn" onclick="navTo('screenProducts')">üì¶ Productos</div>
                <div class="dash-btn" onclick="navTo('screenSections')">üìë Secciones</div>
                <div class="dash-btn" onclick="navTo('screenCover')">üé® Portada</div>
                <div class="dash-btn" onclick="navTo('screenConfig')">‚öôÔ∏è Config</div>
                <div class="dash-btn" onclick="navTo('screenUsers')">üë• Verificaci√≥n</div>
                <div class="dash-btn" onclick="navTo('screenChats')">üí¨ Usuarios Conectados</div>
            </div>
            <br>
            <div style="background:#222; padding:15px; border-radius:8px;">
                <p>Usuarios: <span id="statUsers">0</span></p>
            </div>
        </div>

        <div id="screenProducts" class="admin-section hidden">
            <h4>Nuevo Producto</h4>
            <select id="prodSectionSelect"></select>
            <input type="file" id="prodImgInput" accept="image/*">
            <input id="prodName" placeholder="Nombre">
            <div style="display:flex; gap:10px;">
                <input id="prodPrice" type="number" placeholder="Precio">
                <input id="prodCurrency" placeholder="Moneda" value="CUP">
            </div>
            <textarea id="prodDesc" rows="3" placeholder="Descripci√≥n..."></textarea>
            <div style="margin-bottom:10px;"><input type="checkbox" id="prodFeatured"> Destacar</div>
            <button class="btn btn-main" onclick="saveProduct()">GUARDAR</button>
            <hr>
            <h4>Inventario (Eliminar)</h4>
            <div id="fullInventoryList"></div>
        </div>

        <div id="screenSections" class="admin-section hidden">
            <div style="display:flex; gap:5px;">
                <input id="newSectionName" placeholder="Nueva Secci√≥n">
                <button class="btn btn-main" style="width:auto;" onclick="addSection()">+</button>
            </div>
            <div id="sectionListContainer"></div>
        </div>

        <div id="screenCover" class="admin-section hidden">
            <h4>Personalizar Portada</h4>
            <input id="cfgLandTitle" placeholder="T√≠tulo Portada">
            <input type="file" id="cfgLandImg" accept="image/*">
            <button class="btn btn-danger" onclick="clearCoverImg()">Quitar Fondo</button>
            
            <label>Bot√≥n de Entrada (Estilo y Animaci√≥n)</label>
            <input id="cfgBtnText" placeholder="Texto Bot√≥n">
            <select id="cfgBtnStyle">
                <option value="btn-neon-blue">Azul Cyber</option>
                <option value="btn-neon-red">Rojo Fuego</option>
                <option value="btn-neon-green">Verde Hacker</option>
                <option value="btn-neon-purple">P√∫rpura Synth</option>
                <option value="btn-neon-gold">Oro Brillante</option>
                <option value="btn-neon-pink">Rosa Ne√≥n</option>
                <option value="btn-neon-cyan">Cyan Futuro</option>
                <option value="btn-neon-orange">Naranja Plasma</option>
            </select>
            <select id="cfgBtnAnim">
                <option value="anim-pulse">Pulso</option>
                <option value="anim-bounce">Rebote</option>
                <option value="anim-shake">Temblor</option>
                <option value="anim-spin">Giro Lento</option>
                <option value="anim-wobble">Gelatina</option>
                <option value="anim-jello">Jello</option>
                <option value="anim-heartbeat">Latido</option>
                <option value="anim-flip">Voltereta</option>
                <option value="anim-zoomIn">Zoom In</option>
                <option value="anim-slideUp">Deslizar Arriba</option>
            </select>
            <button class="btn btn-main" onclick="saveCoverConfig()">APLICAR</button>
        </div>

        <div id="screenConfig" class="admin-section hidden">
            <h4>Configuraci√≥n General</h4>
            <label>T√≠tulo App (Cabecera)</label>
            <input id="cfgAppTitle" placeholder="Ej: Virtud Store">
            
            <label>Subt√≠tulo y Animaci√≥n</label>
            <div style="display:flex; gap:5px;">
                <input id="cfgAppSub">
                <select id="cfgSubAnim" style="width:40%;">
                    <option value="sub-fade">Fade</option>
                    <option value="sub-slide">Slide</option>
                    <option value="sub-glitch">Glitch</option>
                    <option value="sub-neon">Neon</option>
                    <option value="sub-type">Tipeo</option>
                </select>
            </div>
            
            <label>Texto Bot√≥n Carrito</label>
            <input id="cfgOrderBtnText">
            
            <label>Texto Bot√≥n "Agregar al carrito" (Detalle)</label>
            <input id="cfgDetailBtnText" placeholder="Ej: ¬°Lo quiero!">

            <label>COLOR GLOBAL (Botones/Tabs)</label>
            <input type="color" id="cfgGlobalColor" style="height:50px; padding:0;">
            
            <button class="btn btn-main" onclick="saveGeneralConfig()">GUARDAR</button>
        </div>

        <div id="screenUsers" class="admin-section hidden">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px; background:#222; padding:10px;">
                <input type="checkbox" id="authEnabledCheck" style="width:20px;">
                <label for="authEnabledCheck">Habilitar Registro de Usuarios</label>
            </div>
            <h4>Lista de Usuarios</h4>
            <div id="userListAdmin"></div>
        </div>

        <div id="screenChats" class="admin-section hidden">
            <h4>Config Chat</h4>
            <input id="adminAutoReply" placeholder="Respuesta Autom√°tica...">
            <input id="adminPicUrl" placeholder="URL Foto Admin (Opcional)">
            <hr>
            <h4>Chats Activos</h4>
            <div id="activeChatsList"></div>
            
            <div id="adminChatView" class="hidden chat-container" style="border-top:2px solid var(--primary); margin-top:20px;">
                <div style="background:#222; padding:5px; font-weight:bold;">Chat con: <span id="chattingWithUser"></span> <button onclick="closeAdminChat()" style="float:right;">X</button></div>
                <div class="chat-messages" id="adminChatMsgs" style="height:200px;"></div>
                <div class="chat-input-area">
                    <input id="adminChatInput" placeholder="Responder...">
                    <button class="btn btn-main" style="width:auto;" onclick="adminSendMsg()">‚û§</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
/* --- BASE DE DATOS LOCAL --- */
const defaultDB = {
    config: {
        landingTitle: "VIRTUD",
        landingBtnText: "ENTRAR",
        landingBtnStyle: "btn-neon-blue",
        landingBtnAnim: "anim-pulse",
        landingBg: null,
        appTitle: "VIRTUD STORE",
        appSubtitle: "Bienvenido",
        subAnim: "sub-fade",
        searchPlaceholder: "Buscar...",
        orderBtnText: "HACER PEDIDO",
        detailBtnText: "¬°AGREGAR AL CARRITO!",
        globalColor: "#00f2ff",
        authEnabled: true,
        autoReply: "Hola, en breve te atendemos.",
        adminPic: ""
    },
    sections: ["Combos", "Aseo", "Tecnolog√≠a"],
    products: [],
    users: [], // {id, name, email, isAdmin}
    chats: {}  // { userId: [ {from:'user', text:'hola'}, {from:'admin', text:'que tal'} ] }
};

let db = JSON.parse(localStorage.getItem('virtud_db')) || defaultDB;
let activeSection = db.sections[0] || "";
let cart = [];
let currentUser = JSON.parse(localStorage.getItem('virtud_user')) || null;
let currentAdminChatUser = null; // ID del usuario con quien habla el admin

/* --- INICIO --- */
function init() {
    applyConfig();
    if(localStorage.getItem('isAdmin') === 'true') document.getElementById('adminTrigger').style.display = 'flex';
    // Check auth
    if(db.config.authEnabled) document.getElementById('userAuthIcon').classList.remove('hidden');
    updateAuthStatus();
}

function enterSite() {
    document.getElementById('landing').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('cartBtn').style.display = 'flex';
    if(localStorage.getItem('isAdmin') === 'true') document.getElementById('adminTrigger').style.display = 'flex';
    renderNav();
    renderContent();
}

function applyConfig() {
    const c = db.config;
    document.documentElement.style.setProperty('--dynamic-color', c.globalColor || '#00f2ff');
    
    document.getElementById('landingTitle').innerText = c.landingTitle;
    const lBtn = document.getElementById('landingBtn');
    lBtn.innerText = c.landingBtnText;
    lBtn.className = `btn ${c.landingBtnStyle} ${c.landingBtnAnim}`;
    if(c.landingBg) document.getElementById('landing').style.backgroundImage = `url(${c.landingBg})`;
    
    document.getElementById('appTitle').innerText = c.appTitle || "VIRTUD STORE";
    document.getElementById('appSubtitle').innerText = c.appSubtitle;
    document.getElementById('appSubtitle').className = `subtitle ${c.subAnim}`;
    document.getElementById('mainSearch').placeholder = c.searchPlaceholder;
    document.getElementById('btnMakeOrder').innerText = c.orderBtnText;
    document.getElementById('detailAddBtn').innerText = c.detailBtnText;
    
    // Auth Toggle
    if(!c.authEnabled) document.getElementById('userAuthIcon').classList.add('hidden');
    else document.getElementById('userAuthIcon').classList.remove('hidden');
}

/* --- RENDERIZADO --- */
function renderNav() {
    const nav = document.getElementById('sectionsNav');
    nav.innerHTML = "";
    if(db.sections.length === 0) { nav.innerHTML = "<span style='color:white; padding:10px;'>Sin secciones</span>"; return; }
    if(!db.sections.includes(activeSection) && db.sections.length > 0) activeSection = db.sections[0];

    db.sections.forEach(sec => {
        const tab = document.createElement('div');
        tab.className = `section-tab ${sec === activeSection ? 'active' : ''}`;
        tab.innerText = sec;
        tab.onclick = () => { activeSection = sec; renderNav(); renderContent(); };
        nav.appendChild(tab);
    });
}

function renderContent() {
    const area = document.getElementById('contentArea');
    area.innerHTML = "";
    const prods = db.products.filter(p => p.section === activeSection);
    
    if(prods.length === 0) { area.innerHTML = `<div style="text-align:center; padding:40px; color:#555;">Vac√≠o</div>`; return; }

    const grid = document.createElement('div');
    grid.className = 'grid';
    prods.sort((a,b) => (b.featured ? 1 : 0) - (a.featured ? 1 : 0));

    prods.forEach(p => {
        grid.innerHTML += `
        <div class="card">
            ${p.featured ? '<span class="featured-tag" style="position:absolute;top:0;left:0;background:var(--accent);color:white;padding:2px 8px;font-size:0.7rem;font-weight:bold;">‚òÖ</span>' : ''}
            <img src="${p.image || ''}" onclick="openProdDetail('${p.id}')">
            <div class="card-content">
                <h4>${p.name}</h4>
                <div class="price">$${p.price}</div>
                <button class="btn btn-dynamic" style="margin-top:5px; font-size:0.8rem; width:100%;" onclick="addToCart(event, '${p.id}')">AGREGAR</button>
            </div>
        </div>`;
    });
    area.appendChild(grid);
}

/* --- DETALLE PRODUCTO --- */
let currentDetailId = null;
function openProdDetail(id) {
    const p = db.products.find(x => x.id === id);
    if(!p) return;
    currentDetailId = id;
    document.getElementById('detailTitle').innerText = p.name;
    document.getElementById('prodDetailImg').src = p.image || '';
    document.getElementById('detailPrice').innerText = `$${p.price} ${p.currency}`;
    document.getElementById('detailDesc').innerText = p.description || "Sin descripci√≥n.";
    document.getElementById('detailAddBtn').onclick = (e) => { addToCart(e, id); closeDetail(); };
    document.getElementById('productDetailModal').classList.remove('hidden');
}
function closeDetail() { document.getElementById('productDetailModal').classList.add('hidden'); }

/* --- CARRITO & WHATSAPP --- */
function addToCart(e, id) {
    // Sonido simple
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator(); osc.connect(ctx.destination);
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.1);
    osc.start(); osc.stop(ctx.currentTime + 0.1);

    const prod = db.products.find(p => p.id === id);
    const existing = cart.find(item => item.id === id);
    if(existing) existing.qty++; else cart.push({...prod, qty: 1});
    updateCartUI();

    // Flecha
    const btn = e.target;
    const cBtn = document.getElementById('cartBtn');
    const r1 = btn.getBoundingClientRect();
    const r2 = cBtn.getBoundingClientRect();
    const arr = document.createElement('div');
    arr.className = 'flying-arrow'; arr.innerHTML = '‚û§';
    arr.style.left = r1.left+'px'; arr.style.top = r1.top+'px';
    document.body.appendChild(arr);
    setTimeout(()=> { arr.style.left = r2.left+'px'; arr.style.top = r2.top+'px'; arr.style.opacity=0; arr.style.transform='scale(0.2)'; }, 50);
    setTimeout(()=>arr.remove(), 1000);
}

function updateCartUI() {
    const totalQty = cart.reduce((acc, item) => acc + item.qty, 0);
    document.getElementById('cartBtn').innerText = totalQty;
    const list = document.getElementById('cartItemsList');
    let totalMoney = 0;
    list.innerHTML = cart.map(item => {
        totalMoney += item.price * item.qty;
        return `<div class="list-item">
            <div><b>${item.name}</b><br><small>$${item.price} x ${item.qty}</small></div>
            <div>
                <button onclick="changeQty('${item.id}', -1)" style="color:white; background:#444; border:none; width:25px;">-</button>
                <button onclick="changeQty('${item.id}', 1)" style="color:white; background:var(--primary); color:black; border:none; width:25px;">+</button>
            </div>
        </div>`;
    }).join('');
    document.getElementById('cartTotalDisplay').innerText = `$${totalMoney.toFixed(2)}`;
}

function changeQty(id, d) {
    const item = cart.find(i => i.id === id);
    item.qty += d;
    if(item.qty <= 0) cart = cart.filter(i => i.id !== id);
    updateCartUI();
}
function toggleCart() { document.getElementById('cartModal').classList.toggle('hidden'); }

// ENVIAR WHATSAPP (FORMATO V1.1)
function sendOrder() {
    if(cart.length === 0) return alert("Carrito vac√≠o");
    let msg = "Hola, me interesa este pedido:\n\n";
    let total = 0;
    cart.forEach(p => {
        msg += `üì¶ ${p.name} (x${p.qty}) - $${p.price * p.qty}\n`;
        total += p.price * p.qty;
    });
    msg += `\nüí∞ *TOTAL A PAGAR: $${total.toFixed(2)}*`;
    
    // Codificar para URL
    const url = `https://wa.me/5358876921?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
}

/* --- AUTH & CHAT SYSTEM --- */
function updateAuthStatus() {
    const dot = document.getElementById('authStatusDot');
    if(currentUser) dot.classList.add('online'); else dot.classList.remove('online');
}
function openAuthModal() {
    document.getElementById('authModal').classList.remove('hidden');
    if(currentUser) {
        document.getElementById('authForms').classList.add('hidden');
        document.getElementById('userChatView').classList.remove('hidden');
        document.getElementById('authTitle').innerText = "CHAT CON SOPORTE";
        renderUserChat();
    } else {
        document.getElementById('authForms').classList.remove('hidden');
        document.getElementById('userChatView').classList.add('hidden');
    }
}
function closeAuth() { document.getElementById('authModal').classList.add('hidden'); }

function registerUser() {
    const name = document.getElementById('userNameInput').value;
    const email = document.getElementById('userEmailInput').value;
    if(!name || !email) return alert("Datos requeridos");
    
    // Check if exists
    let user = db.users.find(u => u.email === email);
    if(!user) {
        user = { id: Date.now().toString(), name, email, isAdmin: false };
        db.users.push(user);
        saveDB();
    }
    currentUser = user;
    localStorage.setItem('virtud_user', JSON.stringify(user));
    alert("¬°Bienvenido " + name + "!");
    openAuthModal(); // Refresca vista a chat
    updateAuthStatus();
}

// Chat User Side
function renderUserChat() {
    if(!currentUser) return;
    const msgs = db.chats[currentUser.id] || [];
    const div = document.getElementById('userChatMsgs');
    div.innerHTML = msgs.map(m => `
        <div class="msg-bubble ${m.from === 'user' ? 'msg-me' : 'msg-other'}">
            ${m.from !== 'user' && db.config.adminPic ? `<img src="${db.config.adminPic}" class="admin-pic">` : ''}
            ${m.text}
        </div>
    `).join('');
    div.scrollTop = div.scrollHeight;
}

function userSendMsg() {
    const txt = document.getElementById('userChatInput').value;
    if(!txt) return;
    if(!db.chats[currentUser.id]) db.chats[currentUser.id] = [];
    
    // Add user msg
    db.chats[currentUser.id].push({ from: 'user', text: txt, time: Date.now() });
    
    // Auto-reply (si es primer mensaje o config)
    if(db.config.autoReply && db.chats[currentUser.id].length === 1) {
        setTimeout(() => {
            db.chats[currentUser.id].push({ from: 'admin', text: db.config.autoReply, time: Date.now() });
            saveDB(); renderUserChat();
        }, 1000);
    }
    
    saveDB();
    document.getElementById('userChatInput').value = "";
    renderUserChat();
}

/* --- ADMIN LOGIC EXTENDED --- */
function openAdmin() {
    if(localStorage.getItem('isAdmin') === 'true'){
        document.getElementById('adminPanel').classList.remove('hidden');
        return;
    }
    if(prompt("Clave:") === "separabit2020") {
        localStorage.setItem('isAdmin', 'true');
        document.getElementById('adminPanel').classList.remove('hidden');
    }
}
function minimizeAdmin() { document.getElementById('adminPanel').classList.add('hidden'); }
function closeAdmin(logout) { 
    document.getElementById('adminPanel').classList.add('hidden'); 
    if(logout) { localStorage.removeItem('isAdmin'); location.reload(); }
}

function navTo(id) {
    document.querySelectorAll('.admin-section').forEach(e => e.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.getElementById('adminDashboard').classList.add('hidden');
    document.getElementById('adminBackBtn').classList.remove('hidden');
    
    if(id === 'screenProducts') { renderSectionSelect(); renderFullInventory(); }
    if(id === 'screenSections') renderAdminSections();
    if(id === 'screenCover') loadCoverValues();
    if(id === 'screenConfig') loadConfigValues();
    if(id === 'screenUsers') renderAdminUsers();
    if(id === 'screenChats') renderAdminChats();
}

function adminBack() {
    document.querySelectorAll('.admin-section').forEach(e => e.classList.add('hidden'));
    document.getElementById('adminDashboard').classList.remove('hidden');
    document.getElementById('adminBackBtn').classList.add('hidden');
    document.getElementById('statUsers').innerText = db.users.length;
}

// PRODUCTOS & SECCIONES (Ya exist√≠an, resumido)
function renderSectionSelect() { document.getElementById('prodSectionSelect').innerHTML = db.sections.map(s=>`<option>${s}</option>`).join(''); }
function renderFullInventory() { document.getElementById('fullInventoryList').innerHTML = db.products.map(p=>`<div class="list-item"><span>${p.name}</span><button style="color:red;" onclick="delProd('${p.id}')">X</button></div>`).join(''); }
function delProd(id) { if(confirm('Borrar?')){ db.products = db.products.filter(p=>p.id!==id); saveDB(); renderFullInventory(); } }
function saveProduct() { 
    // L√≥gica igual a V1.0 pero asegurando guardar
    const name = document.getElementById('prodName').value;
    const price = document.getElementById('prodPrice').value;
    if(!name) return;
    const file = document.getElementById('prodImgInput').files[0];
    const newP = { id:Date.now().toString(), name, price:parseFloat(price), section:document.getElementById('prodSectionSelect').value, featured:document.getElementById('prodFeatured').checked, currency: document.getElementById('prodCurrency').value, description: document.getElementById('prodDesc').value, image:null };
    
    if(file) {
        const r = new FileReader();
        r.onload = e => { newP.image = e.target.result; db.products.push(newP); saveDB(); renderFullInventory(); alert("Guardado"); };
        r.readAsDataURL(file);
    } else { db.products.push(newP); saveDB(); renderFullInventory(); alert("Guardado"); }
}
function addSection(){ const n = document.getElementById('newSectionName').value; if(n){ db.sections.push(n); saveDB(); renderAdminSections(); } }
function renderAdminSections(){ document.getElementById('sectionListContainer').innerHTML = db.sections.map((s,i)=>`<div class="list-item">${s} <button onclick="delSec(${i})">X</button></div>`).join(''); }
function delSec(i){ db.sections.splice(i,1); saveDB(); renderAdminSections(); }

// CONFIGURACIONES
function loadCoverValues() {
    const c = db.config;
    document.getElementById('cfgLandTitle').value = c.landingTitle;
    document.getElementById('cfgBtnText').value = c.landingBtnText;
    document.getElementById('cfgBtnStyle').value = c.landingBtnStyle;
    document.getElementById('cfgBtnAnim').value = c.landingBtnAnim;
}
function saveCoverConfig() {
    const c = db.config;
    c.landingTitle = document.getElementById('cfgLandTitle').value;
    c.landingBtnText = document.getElementById('cfgBtnText').value;
    c.landingBtnStyle = document.getElementById('cfgBtnStyle').value;
    c.landingBtnAnim = document.getElementById('cfgBtnAnim').value;
    const f = document.getElementById('cfgLandImg').files[0];
    if(f) { const r=new FileReader(); r.onload=e=>{c.landingBg=e.target.result; saveDB(); applyConfig();}; r.readAsDataURL(f); }
    else { saveDB(); applyConfig(); }
    alert("Portada Actualizada");
}
function clearCoverImg(){ db.config.landingBg=null; saveDB(); alert("Fondo borrado"); }

function loadConfigValues() {
    const c = db.config;
    document.getElementById('cfgAppTitle').value = c.appTitle;
    document.getElementById('cfgAppSub').value = c.appSubtitle;
    document.getElementById('cfgSubAnim').value = c.subAnim;
    document.getElementById('cfgOrderBtnText').value = c.orderBtnText;
    document.getElementById('cfgDetailBtnText').value = c.detailBtnText;
    document.getElementById('cfgGlobalColor').value = c.globalColor;
}
function saveGeneralConfig() {
    const c = db.config;
    c.appTitle = document.getElementById('cfgAppTitle').value;
    c.appSubtitle = document.getElementById('cfgAppSub').value;
    c.subAnim = document.getElementById('cfgSubAnim').value;
    c.orderBtnText = document.getElementById('cfgOrderBtnText').value;
    c.detailBtnText = document.getElementById('cfgDetailBtnText').value;
    c.globalColor = document.getElementById('cfgGlobalColor').value;
    saveDB(); applyConfig(); alert("Config Guardada");
}

// USUARIOS
function renderAdminUsers() {
    document.getElementById('authEnabledCheck').checked = db.config.authEnabled;
    document.getElementById('authEnabledCheck').onchange = (e) => { db.config.authEnabled = e.target.checked; saveDB(); };
    
    document.getElementById('userListAdmin').innerHTML = db.users.map(u => `
        <div class="list-item">
            <div>${u.name} <small>(${u.email})</small> ${u.isAdmin?'‚≠ê':''}</div>
            <div>
                <button onclick="toggleAdmin('${u.id}')">üëë</button>
                <button onclick="delUser('${u.id}')" style="color:red;">‚úñ</button>
            </div>
        </div>
    `).join('');
}
function toggleAdmin(id) { const u = db.users.find(x=>x.id===id); u.isAdmin = !u.isAdmin; saveDB(); renderAdminUsers(); }
function delUser(id) { if(confirm("¬øEliminar usuario?")) { db.users = db.users.filter(x=>x.id!==id); saveDB(); renderAdminUsers(); } }

// CHATS ADMIN
function renderAdminChats() {
    document.getElementById('adminAutoReply').value = db.config.autoReply || "";
    document.getElementById('adminPicUrl').value = db.config.adminPic || "";
    
    // Guardar configs chat al salir o cambiar input
    document.getElementById('adminAutoReply').onchange = (e) => { db.config.autoReply = e.target.value; saveDB(); };
    document.getElementById('adminPicUrl').onchange = (e) => { db.config.adminPic = e.target.value; saveDB(); };

    // Listar usuarios con chats
    const userIds = Object.keys(db.chats);
    document.getElementById('activeChatsList').innerHTML = userIds.map(uid => {
        const u = db.users.find(x=>x.id === uid) || {name: 'Desconocido', id: uid};
        return `<div class="dash-btn" style="padding:10px; margin-bottom:5px; text-align:left;" onclick="openAdminChat('${uid}')">
            üí¨ ${u.name} <small>(Msgs: ${db.chats[uid].length})</small>
        </div>`;
    }).join('');
}

function openAdminChat(uid) {
    currentAdminChatUser = uid;
    document.getElementById('adminChatView').classList.remove('hidden');
    const u = db.users.find(x=>x.id === uid);
    document.getElementById('chattingWithUser').innerText = u ? u.name : "Usuario";
    renderAdminChatMsgs();
}
function closeAdminChat() { document.getElementById('adminChatView').classList.add('hidden'); currentAdminChatUser = null; }

function renderAdminChatMsgs() {
    if(!currentAdminChatUser) return;
    const msgs = db.chats[currentAdminChatUser];
    const div = document.getElementById('adminChatMsgs');
    div.innerHTML = msgs.map(m => `
        <div class="msg-bubble ${m.from === 'admin' ? 'msg-me' : 'msg-other'}">
            ${m.text}
        </div>
    `).join('');
    div.scrollTop = div.scrollHeight;
}

function adminSendMsg() {
    const txt = document.getElementById('adminChatInput').value;
    if(!txt || !currentAdminChatUser) return;
    db.chats[currentAdminChatUser].push({ from: 'admin', text: txt, time: Date.now() });
    saveDB();
    document.getElementById('adminChatInput').value = "";
    renderAdminChatMsgs();
}

// SEARCH ENGINE
function searchEngine(text) {
    const area = document.getElementById('contentArea');
    const nav = document.getElementById('sectionsNav');
    if(text === "") { nav.classList.remove('hidden'); renderContent(); return; }
    nav.classList.add('hidden');
    const res = db.products.filter(p => p.name.toLowerCase().includes(text.toLowerCase()));
    if(res.length===0){ area.innerHTML="<div style='padding:20px;text-align:center'>Sin resultados</div>"; return;}
    const grid = document.createElement('div'); grid.className='grid';
    res.forEach(p=>{
        grid.innerHTML += `<div class="card"><img src="${p.image||''}" onclick="openProdDetail('${p.id}')">
            <div class="card-content"><h4>${p.name}</h4><div class="price">$${p.price}</div>
            <button class="btn btn-dynamic" style="width:100%" onclick="addToCart(event, '${p.id}')">AGREGAR</button></div></div>`;
    });
    area.innerHTML=""; area.appendChild(grid);
}

function saveDB() { localStorage.setItem('virtud_db', JSON.stringify(db)); }
init();
</script>
</body>
</html>
